;UNIVERSIDAD DEL VALLE DE GUATEMALA
;IE2023: PROGRAMACI?N DE MICROCONTROLADORES
;Laboratorio3.asm
;AUTOR: Christian Quelex
;PROYECTO: Contador binario de 4 bits
;HARDWARE: ATMEGA328P
;CREADO: 30/01/2024


;ISR_TIMER0

.INCLUDE "M328PDEF.INC"
.CSEG
.ORG 0X00
	JMP SETUP			//RESET VECTOR
.ORG 0X0020
	JMP ISR_TIMER0		//ISR: TIMER0 VECTOR


MAIN:

	LDI		R16, LOW(RAMEND)
	OUT		SPL, R16
	LDI		R17, HIGH(RAMEND)
	OUT		SPH, R17

	SEG: .DB 0x3F,0x06,0x5B,0x4F,0x66,0x6D,0x7D,0x07,0x7F,0x6F,0x77,0x7C,0x39,0x5E,0x79,0x71

SETUP:
	LDI	R16, 0x00		// deshabilitar puertos usart
	STS	UCSR0B, R16
	
	LDI		R16, 0xFF		// Salidas puertos D
	OUT		DDRD, R16
	LDI		R16, 0x00
	OUT		PORTD, R16

	//SBI		PORTD, PD2
	//SBI		PORTD, PD3		;PD2 AND PD3 AS INPUT W PULL-UP

	//CBI		DDRD, PD2
	//CBI		DDRD, PD3
	//SBI		DDRD, PD7

	LDI		R21, 0
	LDI		ZH, HIGH(SEG << 1)
	LDI		ZL, LOW(SEG << 1)
	ADD		ZL, R21
	LPM		R21, Z
	
	CALL	INIT_T0

	SEI					;ENABLE GLOBAL INTERRUPTIONS

	LDI		R20, 0			// Contador de timer
	LDI		R21, 0			// Contador de Display


LOOP:
	CPI		R20, 99			; 100 * 10ms = 1000ms
	BRNE	LOOP
	CLR		R20				//Limpiar R20 
	
	CALL	DISPLAY

	INC		R21
	SBRC	R21, 4		// Resetear a 0
	LDI		R21, 0

	JMP		LOOP


DISPLAY:
	CLR		R22
	//CBI		PORTD, PD7
	MOV		R22, R21
	LDI		ZH, HIGH(SEG << 1)
	LDI		ZL, LOW(SEG << 1)
	ADD		ZL, R22
	LPM		R22, Z
	
	OUT		PORTD, R22

	//SBRC	R22, 6
	//SBI		PIND, PD7
	//SBRS	R22, 6
	//CBI		PORTD, PD7

	RET


INIT_T0:
	LDI		R16, (1 << CS02) | (1 << CS00)
	OUT		TCCR0B, R16			// Prescaler de 1024

	LDI		R16, 99			;OVERFLOW VALUE, EVERY 10ms
	OUT		TCNT0, R16		// Cargar el inicio para el timer

	LDI		R16, (1 << TOIE0)
	STS		TIMSK0, R16			;INTERRUPTION ENABLE
	RET

ISR_TIMER0:
	LDI		R16, 99			;VALUE OF TIMER OVERFLOW
	OUT		TCNT0, R16		;LOAD THE OVERFLOW VALUE
	SBI		TIFR0, TOV0		;TURN OFF FLAG
	INC		R20				;INCREASE COUNTER OF 10ms
	RETI					// Regreso de Rutina de interrupcion
